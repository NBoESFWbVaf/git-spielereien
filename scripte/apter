#!/bin/bash
clear

# Funktion: Timeshift-Snapshot erstellen
create_timeshift_snapshot() {
    local comment="$1"
    if command -v timeshift &> /dev/null; then
        echo "Erstelle Timeshift-Snapshot: $comment"
        sudo timeshift --create --comments "$comment" --tags D --skip-grub
        if [ $? -ne 0 ]; then
            echo "Fehler: Timeshift-Snapshot fehlgeschlagen." >&2
            return 1
        fi
    else
        echo "Timeshift ist nicht installiert. Überspringe Snapshot."
    fi
}

# Hilfe anzeigen
show_help() {
    echo "Verwendung: $0 [OPTION]"
    echo "Optionen:"
    echo "  -s, --system      Nur Systempakete aktualisieren"
    echo "  -f, --flatpak     Nur Flatpaks aktualisieren und bereinigen"
    echo "  -k, --kernel      Nur alte Kernel entfernen"
    echo "  -n, --snap        Nur Snaps aktualisieren und bereinigen"
    echo "  -c, --clean       Temporäre Dateien, Logs und Docker bereinigen"
    echo "  -a, --all         Alle Aktionen ausführen"
    echo "  -h, --help        Diese Hilfe anzeigen"
    echo " Kombinationen ebenfalls möglich. Bsp: apter -s -f"
    exit 0
}

# Systempakete aktualisieren, upgraden und bereinigen
update_system() {
    echo "Aktualisiere Systempakete..."
    if ! sudo apt update; then
        echo "Fehler: apt update fehlgeschlagen." >&2
        return 1
    fi
    if ! sudo apt upgrade -y; then
        echo "Fehler: apt upgrade fehlgeschlagen." >&2
        return 1
    fi
    if ! sudo apt full-upgrade -y; then
        echo "Fehler: apt full-upgrade fehlgeschlagen." >&2
        return 1
    fi
    if ! sudo apt autoremove -y; then
        echo "Fehler: apt autoremove fehlgeschlagen." >&2
        return 1
    fi
    if ! sudo apt autoclean -y; then
        echo "Fehler: apt autoclean fehlgeschlagen." >&2
        return 1
    fi
}

# Flatpaks aktualisieren und bereinigen
update_flatpaks() {
    if command -v flatpak &> /dev/null; then
        echo "Aktualisiere Flatpaks..."
        if ! flatpak update -y; then
            echo "Fehler: flatpak update fehlgeschlagen." >&2
        fi
        if ! flatpak uninstall --unused --delete-data; then
            echo "Fehler: flatpak uninstall --unused --delete-data fehlgeschlagen." >&2
        fi
    else
        echo "Flatpak ist nicht installiert. Überspringe Flatpak-Aktualisierung."
    fi
}

# Alte Kernel entfernen
remove_old_kernels() {
    echo "Suche nach alten Kernels..."

    # Aktuellen Kernel ermitteln
    current_kernel=$(uname -r)
    echo "Aktueller Kernel: $current_kernel"

    # Liste aller installierten Kernel-Pakete (sortiert nach Version, neueste zuerst)
    kernel_list=$(dpkg -l | grep 'linux-image-' | awk '{print $2}' | grep -v "linux-image-extra" | grep -v "linux-image-generic" | sort -rV)

    # Falls weniger als 2 Kernel installiert sind, nichts tun
    if [ $(echo "$kernel_list" | wc -l) -le 2 ]; then
        echo "Weniger als 2 Kernel installiert. Keine alten Kernel zum Entfernen gefunden."
        return
    fi

    # Die beiden neuesten Kernel behalten (aktueller und vorheriger)
    # Der vorherige Kernel ist der zweite in der sortierten Liste (neueste zuerst)
    previous_kernel=$(echo "$kernel_list" | sed -n '2p')

    echo "Aktueller Kernel: $current_kernel"
    echo "Vorheriger Kernel: $previous_kernel"

    # Liste der zu entfernenden Kernel (alle außer den beiden neuesten)
    old_kernels=$(echo "$kernel_list" | grep -v "$current_kernel" | grep -v "$previous_kernel")

    if [ -z "$old_kernels" ]; then
        echo "Keine alten Kernel zum Entfernen gefunden."
        return
    fi

    echo "Folgende alten Kernel werden entfernt:"
    echo "$old_kernels"

    # Sicherheitsabfrage (optional)
    read -p "Möchtest du diese Kernel wirklich entfernen? [J/n] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Jj]$ ]]; then
        echo "Abbruch: Kernel werden nicht entfernt."
        return
    fi

    # Kernel entfernen
    echo "$old_kernels" | xargs sudo apt-get -y purge
}

# Snaps aktualisieren und bereinigen
update_snaps() {
    if command -v snap &> /dev/null; then
        echo "Aktualisiere Snaps..."
        if ! sudo snap refresh; then
            echo "Fehler: snap refresh fehlgeschlagen." >&2
        fi
        if ! sudo snap set system refresh.retain=2; then
            echo "Fehler: snap set system refresh.retain fehlgeschlagen." >&2
        fi
    else
        echo "Snap ist nicht installiert. Überspringe Snap-Aktualisierung."
    fi
}

# Temporäre Dateien und Cache bereinigen
clean_files() {
    echo "Bereinige temporäre Dateien und Cache..."
    if ! sudo rm -rf /tmp/* /var/tmp/*; then
        echo "Fehler: Löschen von /tmp/* oder /var/tmp/* fehlgeschlagen." >&2
    fi

    echo "Behält nur die letzten 50 MB an Logs"
    if ! sudo journalctl --vacuum-size=50M; then
        echo "Fehler: journalctl --vacuum-size fehlgeschlagen." >&2
    fi

    echo "Alte Logs entfernen"
    if ! sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \; 2>/dev/null; then
        echo "Fehler: Löschen alter Logs fehlgeschlagen." >&2
    fi
    if ! sudo find /var/log -type f -name "*.gz" -delete 2>/dev/null; then
        echo "Fehler: Löschen alter komprimierter Logs fehlgeschlagen." >&2
    fi

    echo "Bereinige Paketmanager-Caches..."
    if command -v apt &> /dev/null; then
        if ! sudo apt clean && sudo apt autoclean; then
            echo "Fehler: apt clean/autoclean fehlgeschlagen." >&2
        fi
    fi

    echo "Bereinige Benutzer-Caches für alle Benutzer..."
    if ! sudo find /home -type d -name ".cache" -exec rm -rf {} +; then
        echo "Fehler: Löschen der Benutzer-Caches fehlgeschlagen." >&2
    fi

    echo "Bereinige Thumbnail-Caches für alle Benutzer..."
    if ! sudo find /home -type d -name "thumbnails" -exec rm -rf {} +; then
        echo "Fehler: Löschen der Thumbnail-Caches fehlgeschlagen." >&2
    fi

    # **Bereinige alte Konfigurationsdateien deinstallierter Pakete**
    echo "Bereinige alte Konfigurationsdateien deinstallierter Pakete..."
    if ! sudo apt-get purge $(dpkg -l | grep "^rc" | awk '{print $2}') 2>/dev/null; then
        echo "Fehler: Löschen alter Konfigurationsdateien fehlgeschlagen." >&2
    fi

    # **Bereinige Flatpak-Caches systemweit**
    echo "Bereinige Flatpak-Caches systemweit..."
    if command -v flatpak &> /dev/null; then
        if ! sudo flatpak repair --system; then
            echo "Fehler: flatpak repair --system fehlgeschlagen." >&2
        fi
        # **Entferne ungenutzte Flatpak-Runtimes**
        if ! flatpak uninstall --unused --delete-data; then
            echo "Fehler: flatpak uninstall --unused fehlgeschlagen." >&2
        fi
    else
        echo "Flatpak ist nicht installiert. Überspringe Flatpak-Bereinigung."
    fi

    # **Bereinige Docker (falls installiert)**
    if command -v docker &> /dev/null; then
        echo "Unnötige Docker-Container, Images und Volumes löschen"
        if ! sudo docker system prune -a; then
            echo "Fehler: docker system prune fehlgeschlagen." >&2
        fi
    else
        echo "Docker ist nicht installiert. Überspringe Docker-Bereinigung."
    fi

    # **Bereinige alte Crash-Reports (Apport)**
    echo "Bereinige alte Crash-Reports..."
    if ! sudo rm -rf /var/crash/* 2>/dev/null; then
        echo "Fehler: Löschen alter Crash-Reports fehlgeschlagen." >&2
    fi

    # **Bereinige ungenutzte Sprachpakete (localepurge)**
    echo "Bereinige ungenutzte Sprachpakete..."
    if command -v localepurge &> /dev/null; then
        if ! sudo localepurge 2>/dev/null; then
            echo "Fehler: localepurge fehlgeschlagen." >&2
        fi
    else
        echo "localepurge ist nicht installiert. Überspringe Bereinigung der Sprachpakete."
    fi

    # **Bereinige Python-Caches in Benutzerverzeichnissen**
    echo "Bereinige Python-__pycache__-Ordner..."
    if ! sudo find /home -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null; then
        echo "Fehler: Löschen der Python-Caches fehlgeschlagen." >&2
    fi

    # **Bereinige alte SSH-known_hosts-Einträge**
    echo "Bereinige alte SSH-known_hosts-Einträge..."
    if ! find /home -type f -name "known_hosts" -exec ssh-keygen -f {} -R {} \; 2>/dev/null; then
        echo "Fehler: Bereinigung der SSH-known_hosts fehlgeschlagen." >&2
    fi

    # **Bereinige ungenutzte Systemd-Dienst-Logs**
    echo "Setze fehlgeschlagene Systemd-Dienste zurück..."
    if ! sudo systemctl reset-failed 2>/dev/null; then
        echo "Fehler: Zurücksetzen fehlgeschlagener Systemd-Dienste fehlgeschlagen." >&2
    fi

    # **Bereinige alte Git-Repository-Caches**
    echo "Bereinige Git-Caches in Benutzerverzeichnissen..."
    if ! sudo find /home -type d -name ".git" -exec git gc --aggressive {} \; 2>/dev/null; then
        echo "Fehler: Bereinigung der Git-Caches fehlgeschlagen." >&2
    fi

    # **Bereinige alte Downloads (älter als 30 Tage)**
    #echo "Lösche alte Downloads (älter als 30 Tage)..."
    #if ! find /home/*/Downloads -type f -atime +30 -delete 2>/dev/null; then
    #    echo "Fehler: Löschen alter Downloads fehlgeschlagen." >&2
    #fi

    # **Bereinige ungenutzte Kernel-Module**
    echo "Aktualisiere Kernel-Modul-Abhängigkeiten..."
    if ! sudo depmod -a 2>/dev/null; then
        echo "Fehler: Aktualisierung der Kernel-Modul-Abhängigkeiten fehlgeschlagen." >&2
    fi

    echo "Systembereinigung abgeschlossen."
}


# Hauptprogramm
main() {
    local do_system=false
    local do_flatpak=false
    local do_kernel=false
    local do_snap=false
    local do_clean=false

    # Wenn keine Parameter übergeben wurden, Hilfe anzeigen
    if [ $# -eq 0 ]; then
        show_help
    fi

    # Parameter auswerten
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--system)   do_system=true ;;
            -f|--flatpak)  do_flatpak=true ;;
            -k|--kernel)   do_kernel=true ;;
            -n|--snap)     do_snap=true ;;
            -c|--clean)    do_clean=true ;;
            -a|--all)      do_system=true; do_flatpak=true; do_snap=true; do_clean=true ;;
            -h|--help)     show_help ;;
            *)              echo "Unbekannte Option: $1"; show_help ;;
        esac
        shift
    done

    # Einmalig zu Beginn einen Timeshift-Snapshot erstellen, falls Timeshift installiert ist
    create_timeshift_snapshot "Vor Systemwartung"

    # Aktionen ausführen
    if $do_system;   then update_system;     fi
    if $do_flatpak;  then update_flatpaks;   fi
    if $do_kernel;   then remove_old_kernels; fi
    if $do_snap;     then update_snaps;      fi
    if $do_clean;    then clean_files;        fi

    echo "Systemwartung abgeschlossen."
}

# Skript ausführen
main "$@"
